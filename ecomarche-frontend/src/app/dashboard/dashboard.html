<div class="container mt-4">
  <h1>Tableau de bord EcoMarché</h1>

  <div class="row mt-4">
    <!-- Produits à risque : résumé + graphique -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5>Produits à risque - synthèse</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-4 text-center">
              <div class="h2">{{ produits.length }}</div>
              <div class="small">Total produits</div>
            </div>
            <div class="col-4 text-center">
              <div class="h2">{{ produitsArisque.length }}</div>
              <div class="small">À risque</div>
            </div>
            <div class="col-4 text-center">
              <div class="h2">{{ wasteStats.avgDaysRemaining }}</div>
              <div class="small">Jours restants (moy.)</div>
            </div>
          </div>

          <div>
            <canvas id="wasteChart" width="400" height="200"></canvas>
          </div>
          <div class="mt-3">
            <h6>Ventes (derniers 90 jours)</h6>
            <canvas id="salesChart" width="800" height="200"></canvas>
          </div>
          <div class="mt-3">
            <h6>Top produits (total ventes)</h6>
            <canvas id="topProductsChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5>KPIs - Vue d'ensemble</h5>
        </div>
        <div class="card-body">
          <div *ngIf="kpiOverview; else kpiLoading">
            <div class="row text-center">
              <div class="col-4">
                <div class="h3">{{ kpiOverview.total_revenue | number:'1.0-0' }} FCFA</div>
                <div class="small">Chiffre d'affaires total</div>
              </div>
              <div class="col-4">
                <div class="h3">{{ kpiOverview.avg_daily_sales | number:'1.0-0' }}</div>
                <div class="small">Ventes journalières moy.</div>
              </div>
              <div class="col-4">
                <div class="h3">{{ (kpiOverview.top_categories?.length || 0) }}</div>
                <div class="small">Catégories (top)</div>
              </div>
            </div>
            <div class="mt-3">
              <h6>Evolution (12 derniers mois)</h6>
              <canvas id="seasonalityChart" width="400" height="150"></canvas>
            </div>
          </div>
          <ng-template #kpiLoading>
            <div>Chargement des KPIs...</div>
          </ng-template>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5>Tarification dynamique</h5>
        </div>
        <div class="card-body">
          <div *ngIf="!pricingData">
            <form (ngSubmit)="calculatePricing()">
              <div class="mb-3">
                <label for="pricingProductSelect" class="form-label">Sélectionnez un produit</label>
                <select class="form-select" id="pricingProductSelect" [(ngModel)]="selectedPricingProductId" name="selectedPricingProductId" required>
                  <option [ngValue]="null">-- Choisir un produit --</option>
                  <option *ngFor="let produit of produits" [value]="produit.id">{{ produit.nom }}</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="expiryDaysInput" class="form-label">Jours avant péremption</label>
                <input type="number" class="form-control" id="expiryDaysInput" [(ngModel)]="daysBeforeExpiry" name="daysBeforeExpiry" min="0" max="30" required>
              </div>
              <button type="submit" class="btn btn-primary" [disabled]="!selectedPricingProductId">Calculer le prix</button>
            </form>
          </div>

          <hr />

          <div class="mt-3">
            <h6>Ajouter un produit (enregistrer)</h6>
            <form (ngSubmit)="createProduitLocal(newProduit)">
              <div class="mb-2">
                <input class="form-control" placeholder="Nom" [(ngModel)]="newProduit.nom" name="nom" required />
              </div>
              <div class="mb-2">
                <input class="form-control" placeholder="Catégorie (id)" [(ngModel)]="newProduit.categorie_id" name="categorie_id" type="number" />
              </div>
              <div class="mb-2 row">
                <div class="col-6"><input type="number" class="form-control" placeholder="Stock" [(ngModel)]="newProduit.stock" name="stock" /></div>
                <div class="col-6"><input type="number" step="0.01" class="form-control" placeholder="Prix" [(ngModel)]="newProduit.prix_unitaire" name="prix_unitaire" /></div>
              </div>
              <div class="mb-2">
                <input type="date" class="form-control" [(ngModel)]="newProduit.date_peremption" name="date_peremption" />
              </div>
              <button class="btn btn-success">Enregistrer</button>
            </form>
          </div>

          <div *ngIf="pricingData" class="mt-3">
            <h5>Tarification pour {{ getProductName(pricingData.produit_id) }}</h5>
            <div class="pricing-result p-3 border rounded">
              <div class="row mb-2">
                <div class="col-6">Prix original:</div>
                <div class="col-6 text-end">{{ pricingData.prix_original | number:'1.0-0' }} FCFA</div>
              </div>
              <div class="row mb-2">
                <div class="col-6">Prix recommandé:</div>
                <div class="col-6 text-end text-success fw-bold">{{ pricingData.prix_recommande | number:'1.0-0' }} FCFA</div>
              </div>
              <div class="row mb-2">
                <div class="col-6">Réduction:</div>
                <div class="col-6 text-end">{{ pricingData.pourcentage_reduction }}%</div>
              </div>
              <div class="row mb-2">
                <div class="col-6">Date de péremption:</div>
                <div class="col-6 text-end">{{ pricingData.date_peremption }}</div>
              </div>
              <div class="row">
                <div class="col-6">Jours restants:</div>
                <div class="col-6 text-end" [ngClass]="{'text-danger': pricingData.jours_restants <= 3, 'text-warning': pricingData.jours_restants > 3 && pricingData.jours_restants <= 7}">
                  {{ pricingData.jours_restants }} jours
                </div>
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-secondary" (click)="resetPricing()">Nouveau calcul</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <h5>Produits à risque de gaspillage</h5>
        </div>
        <div class="card-body">
          <div *ngIf="produitsArisque.length === 0" class="text-center py-3">
            <p>Aucun produit à risque de gaspillage pour le moment.</p>
          </div>

          <div *ngIf="produitsArisque.length > 0" class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Produit</th>
                  <th>Catégorie</th>
                  <th>Stock</th>
                  <th>Date de péremption</th>
                  <th>Jours restants</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let produit of produitsArisque" [ngClass]="{'table-danger': produit.jours_restants <= 3, 'table-warning': produit.jours_restants > 3 && produit.jours_restants <= 7}">
                  <td>{{ produit.nom }}</td>
                  <td>{{ produit.categorie }}</td>
                  <td>{{ produit.stock }}</td>
                  <td>{{ produit.date_peremption }}</td>
                  <td>{{ produit.jours_restants }} jours</td>
                  <td>
                    <!-- show discounted price if present; hide or show N/A when price is 0 or missing -->
                    <div *ngIf="produit.prix_affiche !== undefined">
                      Prix: <span *ngIf="produit.prix_affiche > 0">{{ produit.prix_affiche | number:'1.0-0' }} FCFA</span><span *ngIf="!(produit.prix_affiche > 0)">—</span>
                    </div>
                    <div *ngIf="produit.prix_affiche === undefined">
                      Prix: <span *ngIf="produit.prix_unitaire > 0">{{ produit.prix_unitaire | number:'1.0-0' }} FCFA</span><span *ngIf="!(produit.prix_unitaire > 0)">—</span>
                    </div>
                    <button class="btn btn-sm btn-outline-success mt-1" (click)="calculatePricingForProduct(produit.id)">Calculer prix</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h5>Recommandations pour réduire le gaspillage</h5>
        </div>
        <div class="card-body">
          <div *ngIf="recommendations && recommendations.length > 0; else noRecs">
            <p class="small">Liste priorisée des produits à risque, score composite et action recommandée.</p>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Produit</th>
                    <th>Stock</th>
                    <th>Jours rest.</th>
                    <th>Score</th>
                    <th>Driver</th>
                    <th>Action</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let r of recommendations; let i = index">
                    <td>{{ i+1 }}</td>
                    <td>{{ r.nom }}</td>
                    <td>{{ r.stock }}</td>
                    <td>{{ r.jours_restants }}</td>
                    <td>{{ r.risk_score }}</td>
                    <td>{{ r.driver }}</td>
                    <td>{{ r.recommended_action }} ({{ r.recommended_discount }}%)</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" (click)="openRecommendationModal(r)" [disabled]="applyingRecommendation">Appliquer remise</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <ng-template #noRecs>
            <div>Aucune recommandation disponible pour le moment.</div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Confirmation modal (Bootstrap-like) -->
    <div class="modal fade" tabindex="-1" [class.show]="confirmModalVisible" [style.display]="confirmModalVisible ? 'block' : 'none'">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmer la remise</h5>
            <button type="button" class="btn-close" aria-label="Close" (click)="cancelRecommendation()"></button>
          </div>
          <div class="modal-body">
            <div *ngIf="pendingRecommendation">
              <p>Produit: <strong>{{ pendingRecommendation.nom }}</strong></p>
              <p>Jours restants: <strong>{{ pendingRecommendation.jours_restants }}</strong></p>

              <div class="mb-2">
                <label class="form-label">Modifier les informations produit</label>
                <div class="row">
                  <div class="col-6 mb-2">
                    <label for="modalStock" class="form-label">Stock</label>
                    <input id="modalStock" type="number" class="form-control" [(ngModel)]="modalEditedStock" name="modalStock">
                  </div>
                  <div class="col-6 mb-2">
                    <label for="modalDate" class="form-label">Date de péremption</label>
                    <input id="modalDate" type="date" class="form-control" [(ngModel)]="modalEditedDate" name="modalDate">
                  </div>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">Mode de remise</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="autoMode" name="discountMode" [(ngModel)]="discountMode" value="auto">
                    <label class="form-check-label" for="autoMode">Automatique</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="manualMode" name="discountMode" [(ngModel)]="discountMode" value="manual">
                    <label class="form-check-label" for="manualMode">Manuelle</label>
                  </div>
                </div>
              </div>

              <div *ngIf="discountMode === 'auto'" class="mb-2">
                <p>Remise suggérée: <strong>{{ autoDiscount }}%</strong> (calculée à partir de la période avant péremption)</p>
              </div>

              <div *ngIf="discountMode === 'manual'" class="mb-2">
                <label for="manualDiscountInput" class="form-label">Entrez la remise (%)</label>
                <input id="manualDiscountInput" type="number" class="form-control" [(ngModel)]="manualDiscount" min="0" max="100">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cancelRecommendation()">Annuler</button>
            <button type="button" class="btn btn-primary" (click)="confirmApplyRecommendation()" [disabled]="applyingRecommendation">Appliquer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast area -->
    <div class="dm-toast" *ngIf="toastMessage">
      <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">{{ toastMessage }}</div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-secondary text-white"><h5>Ventes par tranche d'âge</h5></div>
        <div class="card-body">
          <div *ngIf="salesByAge; else loadingAge">
            <ul class="list-unstyled">
              <li *ngFor="let a of getSalesByAgeList()">
                <strong>{{ a.age_bucket }}</strong>: {{ a.Daily_Sales | number:'1.0-0' }} ventes
              </li>
            </ul>
          </div>
          <ng-template #loadingAge>Chargement...</ng-template>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-dark text-white"><h5>Produits populaires par saison</h5></div>
        <div class="card-body">
          <div *ngIf="popularBySeason; else loadingPop">
            <div *ngFor="let season of ['DJF','MAM','JJA','SON']">
              <h6>{{ season }}</h6>
              <ul>
                <li *ngFor="let p of getPopularList(season)">{{ p.Product_Name || p.product || p.Product_Name }} ({{ p.Daily_Sales || p.Daily_Sales || p.total_sales || 0 }})</li>
              </ul>
            </div>
          </div>
          <ng-template #loadingPop>Chargement...</ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
